name: Deploy and Auto-Publish Shopify Theme

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
  SHOPIFY_ADMIN_API_TOKEN: ${{ secrets.SHOPIFY_ADMIN_API_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Create new unpublished theme and capture IDs
        id: prep
        run: |
          set -euo pipefail
          API="https://${SHOPIFY_STORE}/admin/api/2024-10"

          # Current live theme id (for backup/logs)
          LIVE_ID=$(curl -s -H "X-Shopify-Access-Token: ${SHOPIFY_ADMIN_API_TOKEN}" \
            "${API}/themes.json" | jq -r '.themes[] | select(.role=="main") | .id')
          echo "live_id=${LIVE_ID}" >> "$GITHUB_OUTPUT"

          # Create new unpublished theme
          NAME="AutoDeploy $(date +%Y%m%d-%H%M%S)"
          RESP=$(curl -s -X POST "${API}/themes.json" \
            -H "X-Shopify-Access-Token: ${SHOPIFY_ADMIN_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"theme\":{\"name\":\"${NAME}\",\"role\":\"unpublished\"}}")

          NEW_ID=$(echo "$RESP" | jq -r '.theme.id')
          if [ -z "$NEW_ID" ] || [ "$NEW_ID" = "null" ]; then
            echo "Failed to create theme"; exit 1
          fi
          echo "new_id=${NEW_ID}" >> "$GITHUB_OUTPUT"
          echo "Created theme ${NEW_ID}"

      - name: Upload theme files
        run: |
          set -euo pipefail
          API="https://${SHOPIFY_STORE}/admin/api/2024-10"
          THEME_ID="${{ steps.prep.outputs.new_id }}"

          # Upload every theme file at repo root (ignore hidden/system folders)
          while IFS= read -r -d '' f; do
            KEY="${f#./}"
            CONTENT=$(base64 -w0 "$f")
            curl -s -X PUT "${API}/themes/${THEME_ID}/assets.json" \
              -H "X-Shopify-Access-Token: ${SHOPIFY_ADMIN_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"asset\":{\"key\":\"${KEY}\",\"attachment\":\"${CONTENT}\"}}" > /dev/null
            echo "Uploaded: ${KEY}"
          done < <(find . -type f -print0 \
            ! -path "./.git/*" \
            ! -path "./.github/*" \
            ! -name ".gitignore")

      - name: Publish new theme
        run: |
          set -euo pipefail
          API="https://${SHOPIFY_STORE}/admin/api/2024-10"
          THEME_ID="${{ steps.prep.outputs.new_id }}"
          curl -s -X PUT "${API}/themes/${THEME_ID}.json" \
            -H "X-Shopify-Access-Token: ${SHOPIFY_ADMIN_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"theme":{"role":"main"}}' > /dev/null
          echo "Published theme ${THEME_ID}"
